pipeline {

  agent any

  parameters {
    string(name: 'DEVELOPMENT_VERSION', defaultValue: '', description: 'Version number for the development stream after the release')
    string(name: 'RELEASE_VERSION', defaultValue: '', description: 'Version number for the release')
    string(name: 'SOURCE_BRANCH', defaultValue: 'master', description: 'Source branch for the release')
    booleanParam(name: 'DRY_RUN', defaultValue: false, description: 'Dry run for the release')
  }

  options {
    buildDiscarder(logRotator(numToKeepStr: '5'))
    skipStagesAfterUnstable()
    timeout(time: 30, unit: 'MINUTES')
    disableConcurrentBuilds()
  }

  tools {
    maven '3.6.3'
    jdk '11.0.1'
  }

  environment {
    BITBUCKET_USER = credentials('11d1c8ab-bef2-4ed4-b79d-eb8d3db3d9f2')
  }

  stages {

    stage('Preparation') {
      steps {
        git branch: "${params.SOURCE_BRANCH}", credentialsId: '11d1c8ab-bef2-4ed4-b79d-eb8d3db3d9f2', url: 'https://extranet.netcetera.biz/bitbucket/scm/nca266gird/girders-boot.git'
        sh "mvn clean release:clean"
      }
    }

    stage ('Release') {
      steps {
        sh "mvn --batch-mode -DdryRun=${params.DRY_RUN} -DdevelopmentVersion=${params.DEVELOPMENT_VERSION} -DreleaseVersion=${params.RELEASE_VERSION} -Dusername=${env.BITBUCKET_USER_USR} -Dpassword=${env.BITBUCKET_USER_PSW} release:prepare release:perform"
      }
    }

    stage ('Site Deployment') {
      steps {
        sh "mvn -f target/checkout/pom.xml site-deploy"
      }
    }

    stage ('Metrics') {
      steps {
        sh "mvn -f target/checkout/pom.xml org.jacoco:jacoco-maven-plugin:prepare-agent " +
          "-Ddependency-logger-infostore-maven-plugin=1.0.1 " +
          "-DinfostoreUrl=https://buildcrew.extranet.netcetera.biz/webis-ws install " +
          "com.netcetera.nca-301-5:dependency-logger-infostore-maven-plugin:aggregate sonar:sonar"
      }
    }

  }

  post {

    always {
      script {
        mail to: 'girders@netcetera.com',
             cc: '',
             bcc: '',
             from: 'ci@netcetera.com',
             replyTo: 'girders@netcetera.com',
             subject: "Release created for Girders ${env.RELEASE_VERSION}",
             body: "Jenkins created a release for Girders ${env.RELEASE_VERSION} from branch ${env.SOURCE_BRANCH} and updated the development stream to ${env.DEVELOPMENT_VERSION}."
      }
    }

  }

}
